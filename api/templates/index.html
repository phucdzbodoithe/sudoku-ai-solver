<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sudoku AI Solver</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            background-color: #f0f2f5; padding: 20px;
        }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        select {
            padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #bdc3c7;
            background-color: white; cursor: pointer;
        }

        .sudoku-container { border: 4px solid #34495e; display: inline-block; position: relative; }
        .grid { display: grid; grid-template-columns: repeat(9, 50px); grid-template-rows: repeat(9, 50px); }
        .grid input {
            width: 100%; height: 100%; text-align: center; font-size: 24px;
            border: 1px solid #bdc3c7; outline: none; box-sizing: border-box; color: #2c3e50;
        }
        .grid input:focus { background-color: #e8f8f5; font-weight: bold; }
        
        /* Kẻ lưới đậm 3x3 */
        .grid input:nth-child(3n) { border-right: 3px solid #34495e; }
        .grid input:nth-child(9n) { border-right: 1px solid #bdc3c7; }
        .grid input:nth-child(n+19):nth-child(-n+27),
        .grid input:nth-child(n+46):nth-child(-n+54) { border-bottom: 3px solid #34495e; }

        .buttons { margin-top: 20px; }
        button {
            padding: 12px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px;
            color: white; margin: 0 5px; font-weight: bold; transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        .btn-gen { background-color: #2980b9; }
        .btn-solve { background-color: #27ae60; }
        .btn-clear { background-color: #e67e22; } 

        /* Phần hiển thị trạng thái & thời gian */
        .status-bar {
            margin-top: 15px;
            font-size: 18px;
            font-weight: 500;
            color: #34495e;
            min-height: 24px;
        }
        .time-highlight { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Đồ Án AI: Sudoku Solver</h1>
    
    <div class="controls">
        <label for="difficulty">Độ khó:</label>
        <select id="difficulty">
            <option value="easy">Dễ (Easy)</option>
            <option value="medium" selected>Trung Bình (Medium)</option>
            <option value="hard">Khó (Hard)</option>
            <option value="expert">Siêu Khó (Expert)</option>
        </select>
        <button class="btn-gen" onclick="generatePuzzle()">Sinh Đề Mới</button>
    </div>

    <div class="sudoku-container">
        <div class="grid" id="sudoku-grid"></div>
    </div>

    <div class="buttons">
        <button class="btn-clear" onclick="clearGrid()">Nhập Đề / Xóa</button>
        <button class="btn-solve" onclick="solveSudoku()">AI Giải Ngay</button>
    </div>

    <div class="status-bar" id="status-text">Sẵn sàng...</div>

    <script>
        const gridContainer = document.getElementById('sudoku-grid');
        const statusText = document.getElementById('status-text');
        const inputs = [];

        // Tạo 81 ô
        for (let i = 0; i < 81; i++) {
            const input = document.createElement('input');
            input.type = 'text'; input.maxLength = 1;
            input.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^1-9]/g, '');
                this.style.color = "#2c3e50"; 
                this.style.fontWeight = "bold";
                statusText.innerText = "Đang nhập đề bài...";
            });
            gridContainer.appendChild(input);
            inputs.push(input);
        }

        async function generatePuzzle() {
            clearGrid();
            statusText.innerText = "Đang sinh đề bài...";
            const level = document.getElementById('difficulty').value;
            try {
                const response = await fetch(`/generate?level=${level}`);
                const data = await response.json();
                if (data.status === 'success') {
                    let flatBoard = data.board.flat();
                    for (let i = 0; i < 81; i++) {
                        let val = flatBoard[i];
                        if (val !== 0) {
                            inputs[i].value = val;
                            inputs[i].style.fontWeight = "bold";
                            inputs[i].readOnly = true;
                            inputs[i].style.backgroundColor = "#ecf0f1";
                        }
                    }
                    statusText.innerText = "Đã sinh đề mới. Hãy bấm 'AI Giải Ngay'";
                }
            } catch (error) { statusText.innerText = "Lỗi kết nối Server!"; }
        }

        async function solveSudoku() {
            let board = [];
            let row = [];
            
            // Lấy dữ liệu
            for (let i = 0; i < 81; i++) {
                let val = inputs[i].value;
                row.push(val === "" ? 0 : parseInt(val));
                if ((i + 1) % 9 === 0) { board.push(row); row = []; }
            }

            statusText.innerText = "AI đang suy nghĩ...";
            
            // --- BẮT ĐẦU BẤM GIỜ ---
            let startTime = performance.now(); 

            try {
                const response = await fetch('/solve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ board: board })
                });
                const data = await response.json();

                // --- KẾT THÚC BẤM GIỜ ---
                let endTime = performance.now();
                let timeTaken = ((endTime - startTime) / 1000).toFixed(4); // Lấy 4 số lẻ sau dấu phẩy

                if (data.status === 'success') {
                    let flatBoard = data.board.flat();
                    for (let i = 0; i < 81; i++) {
                        if (inputs[i].value == "") {
                            inputs[i].value = flatBoard[i];
                            inputs[i].style.color = "#27ae60"; 
                            inputs[i].style.fontWeight = "bold";
                            inputs[i].style.opacity = 0;
                            setTimeout(() => inputs[i].style.opacity = 1, i * 10); 
                        }
                    }
                    // Hiển thị thời gian ra màn hình
                    statusText.innerHTML = `Đã giải xong trong <span class="time-highlight">${timeTaken}s</span>`;
                } else { 
                    statusText.innerText = "Không tìm thấy lời giải! (Kiểm tra lại đề bài)";
                    alert("Không tìm thấy lời giải! Bạn hãy kiểm tra lại các số đã nhập xem có bị trùng lặp không."); 
                }
            } catch (error) { 
                statusText.innerText = "Lỗi kết nối!";
            }
        }

        function clearGrid() {
            inputs.forEach(input => {
                input.value = '';
                input.style.backgroundColor = "white";
                input.readOnly = false;
                input.style.color = "#2c3e50";
                input.style.fontWeight = "normal";
                input.style.opacity = 1;
            });
            inputs[0].focus();
            statusText.innerText = "Sẵn sàng nhập đề bài...";
        }
    </script>
</body>
</html>